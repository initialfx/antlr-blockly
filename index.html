<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>antlr test</title>
<!-- css START -->
<style>
    a {text-decoration:none;color:blue;}

    textarea,input[type=button],#result,input[type=text],select {
        font-size:1.3em;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
    }
    
    textarea,input[type=text],select {
        border: 1px solid #ccc;
        border-radius: 2px;
        box-shadow: 0px 0px 2px #B6B6B6;
    }

    textarea,.weakresult,.result,input[type=text],select {background-color:rgba(252, 252, 252, 0.4);}
    
    input[type=button] {
        -webkit-appearance:none;

        background: #eaefea;
        border: 1px solid #eaefea;
        padding: 4px 11px;
        color: #777;
        box-shadow: 0px 0px 2px #B6B6B6;
        border-radius: 1px;
        text-shadow: 1px 1px 1px #3F9E3F;
        cursor: pointer;
    }

    input[type=button]:hover,textarea:hover,input[type=text]:hover,select:hover { 
        border: 1px solid rgb(87, 198, 232);
        box-shadow: 0px 0px 3px rgb(87, 198, 232);
    }

    .main{padding: 5px;}

    .weakresult {color: gray;opacity: 0.4;filter: alpha(opacity= 40);}
    
    input[type=button],input[type=text],select {margin:10px 10px 10px 0;}
    
    #background {position: fixed;top: 0;left: 0;z-index: -1;width: 100%;height: 100%;pointer-events: none;}
    body,textarea,#result {margin:0;}
    .left {width: 20%;height:100%;float:left;}
    .middle {width: 60%;height:100%; margin: 0; padding: 0;float:left;}
    .right {width: 20%;height:100%;float:left;}
    .middletop {width: 100%; margin:0; margin-top: 4em; padding: 0;}
</style></head><body><pre id="mobilecss" style="display: none;">
    textarea,input[type=button],#result,input[type=text],select {font-size:3em}

    .left {display: none;}
    .middle {width: 100%;height:100%; margin: 0;}
    .right {display: none;}

    .middletop {display: none;}
</pre>
<!-- css END -->
<script type="text/javascript">
    isMobile=0;
    if(navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i)){
        isMobile=1;
    }
    if(isMobile){
        var cssNode=document.createElement("style");
        cssNode.innerHTML=document.getElementById('mobilecss').innerText;
        document.head.appendChild(cssNode);
        //document.head.innerHTML+='<style>'+mobilecss.innerText+'</style>';
    }
</script>
<canvas id="background"></canvas>
<script>
//背景
(function(){
    var background = document.getElementById('background');
    var resize = function(){
        var ratio = window.devicePixelRatio || 1;
        var dc=background.getContext('2d');
        
        background.width = innerWidth*ratio;
        background.height = innerHeight*ratio;
        dc.scale(ratio, ratio);

        var bsize=32+isMobile*32;
        var fullWidth=~~((innerWidth-17)*ratio);
        var fullHeight=~~(innerHeight*ratio);
        
        var fullX=~~(fullWidth/bsize)-1;
        var fullY=~~(fullHeight/bsize)-1;

        var colorA=["#f9f9f9","#fdfdfd"];
        var colorIndex =1;
        for(ii=0;ii<=fullX+1;ii++){
            colorIndex=ii%2;
            for(jj=0;jj<=fullY+1;jj++){
                dc.fillStyle=colorA[colorIndex];
                if(Math.random()<0.03)dc.fillStyle='#'+'ef'[~~(Math.random()*2)]+''+'ef'[~~(Math.random()*2)]+''+'ef'[~~(Math.random()*2)];
                colorIndex=1-colorIndex;
                dc.fillRect(ii*bsize,jj*bsize,bsize,bsize);
            }
        }
    };
    resize();
    window.onresize = resize;
})();
</script>
<div class="left">&nbsp;</div><div class="middle"><div class="middletop">&nbsp;</div><div class="main">

<!-- content START -->

<input id="input_A" spellcheck="false" type="text" style="width: 100%;height: 1.5em;" placeholder="input_A">
</input> 
<br/>

<textarea id="input_B" spellcheck="false" style="width: 100%; height: 10.2em;overflow:y;resize:none;" placeholder="input_B"></textarea>
<br/>

<input type="button" value="ADD" onclick="func_ADD()" />

<input type="button" value="GOTO" onclick="func_GOTO()"   />
<br/>

<pre id='printf_target'><span class="weakresult">result</span></pre>

<!-- content END -->

</div></div><div class="right">&nbsp;</div>

<script type="text/javascript">
    __id__=['mobilecss','printf_target','background','input_A','input_B'];
    __all__=['isMobile','urlmap','printf','func_ADD','func_GOTO','antlr4'];
    
    printf_target = document.getElementById('printf_target');
    background = document.getElementById('background');
    input_A = document.getElementById('input_A');
    input_B = document.getElementById('input_B');

    
(function(){    
    document.getElementsByClassName('middletop')[0].style.marginTop=~~(innerHeight/10)+'px';
    printf = function(str,weak) {
        var node=document.createElement('span');
        if (weak){
            node.setAttribute('class','weakresult');
        } else {
            node.setAttribute('class','result');
        }
        node.innerText=str;
        printf_target.innerHTML='';
        printf_target.appendChild(node);
    }
})();
</script>
<script type="text/javascript">
function func_ADD(){
    //printf(input_A.value);
    console.clear();
    runOne();
}
function func_GOTO(){
    converter.writeMainFile();
}
</script>

<script>
    input_A.value='grammarFile';
    input_B.value=String.raw`grammar MotaAction;

//===============parser===============
//===blockly语句===

//事件  程序入口之一
event_m
    :   '事件' BGNL? Newline action+ BEND
    ;

//为了避免关键字冲突,全部加了_s
//动作
action
    :   text_s
    |   tip_s
    |   setValue_s
    |   show_s
    |   hide_s
    |   trigger_s
    |   revisit_s
    |   exit_s
    |   update_s
    |   sleep_s
    |   battle_s
    |   openDoor_s
    |   changeFloor_s
    |   changePos_0_s
    |   changePos_1_s
    |   openShop_s
    |   disableShop_s
    |   setFg_0_s
    |   setFg_1_s
    |   move_s
    |   moveHero_s
    |   playBgm_s
    |   pauseBgm_s
    |   resumeBgm_s
    |   playSound_s
    |   win_s
    |   lose_s
    |   if_s
    |   choices_s
    |   function_s
    |   pass_s
    ;

text_s
    :   '标题' EvalString? '图像' IdString? ':' EvalString Newline
    ;

tip_s
    :   '显示提示' ':' EvalString Newline
    ;

setValue_s
    :   '变量操作' ':' '名称' idString_e '值' expression Newline
    ;

show_s
    :   '显示事件' 'x' Int ',' 'y' Int '楼层' IdString? '动画时间' Int? Newline
    ;

hide_s
    :   '隐藏事件' 'x' Int? ',' 'y' Int? '楼层' IdString? '动画时间' Int? Newline
    ;

trigger_s
    :   '触发事件' 'x' Int ',' 'y' Int Newline
    ;

revisit_s
    :   '重启当前事件' Newline
    ;

exit_s
    :   '立刻结束当前事件' Newline
    ;

update_s
    :   '更新状态栏和地图显伤' Newline
    ;

sleep_s
    :   '等待' Int '毫秒' Newline
    ;

battle_s
    :   '强制战斗' IdString Newline
    ;

openDoor_s
    :   '开门' 'x' Int ',' 'y' Int '楼层' IdString? Newline
    ;

changeFloor_s
    :   '楼层切换' IdString 'x' Int ',' 'y' Int '朝向' DirectionEx_List '动画时间' Int? Newline
    ;

changePos_0_s
    :   '位置切换' 'x' Int ',' 'y' Int '朝向' DirectionEx_List Newline
    ;
changePos_1_s
    :   '勇士转向' Direction_List Newline
    ;

openShop_s
    :   '打开全局商店' IdString Newline
    ;

disableShop_s
    :   '禁用全局商店' IdString Newline
    ;

setFg_0_s
    :   '更改画面色调' Number ',' Number ',' Number ',' Number '动画时间' Int? Newline
    ;
setFg_1_s
    :   '恢复画面色调' '动画时间' Int? Newline
    ;

move_s
    :   '移动事件' 'x' Int? ',' 'y' Int? '动画时间' Int? '立刻消失' Bool BGNL? StepString Newline
    ;

moveHero_s
    :   '移动勇士' '动画时间' Int? BGNL? StepString Newline
    ;

playBgm_s
    :   '播放背景音乐' EvalString Newline
    ;

pauseBgm_s
    :   '暂停背景音乐' Newline
    ;

resumeBgm_s
    :   '恢复背景音乐' Newline
    ;

playSound_s
    :   '播放音效' EvalString Newline
    ;

win_s
    :   '游戏胜利,原因' ':' EvalString Newline
    ;

lose_s
    :   '游戏失败,原因' ':' EvalString Newline
    ;

if_s
    :   '如果' ':' expression BGNL? Newline action+ '否则' ':' BGNL? Newline action+ BEND Newline
    ;

choices_s
    :   '选项' BGNL? '标题' EvalString? '图像' IdString? ':' EvalString BGNL? Newline choicesContext+ BEND Newline
    ;

choicesContext
    :   '子选项' EvalString BGNL? Newline action+
    ;

function_s
    :   '自定义JS脚本' BGNL? Newline EvalString Newline BEND Newline
    ;

pass_s
    :   Newline
    ;

statExprSplit : '=== statment ^ === expression v ===' ;
//===blockly表达式===

expression
    :   expression Arithmetic_List expression
    |   negate_e
    |   number_e
    |   bool_e
    |   idString_e
    |   evalString_e
    ;

negate_e
    :   '非' expression
    ;

idString_e
    :   IdString
    ;

evalString_e
    :   EvalString
    ;

number_e
    :   Number
    ;

bool_e
    :   Bool
    ;

//===============lexer===============
Arithmetic_List
    :   '+'|'-'|'*'|'/'|'^'|'=='|'!='|'>'|'<'|'>='|'<='|'和'|'或'
    ;

Bool:   'TRUE' 
    |   'FALSE'
    ;

Int :   '0' | [1-9][0-9]* ; // no leading zeros

Number
    :   '-'? Int '.' Int EXP?   // 1.35, 1.35E-9, 0.3, -4.5
    |   '-'? Int EXP            // 1e10 -3e4
    |   '-'? Int                // -3, 45
    ;
fragment EXP : [Ee] [+\-]? Int ; // \- since - means "range" inside [...]

Direction_List
    :   '上'|'下'|'左'|'右'
    ;

DirectionEx_List
    :   '不变'|'上'|'下'|'左'|'右'
    ;

StepString
    :   (Direction_List Int?)+
    ;

IdString
    :   [a-zA-Z_][0-9a-zA-Z_\-:]*
    ;

//转blockly后不准备保留需要加"
EvalString
    :   Equote_double (ESC_double | ~["\\])* Equote_double
    ;

fragment ESC_double :   '\\' (["\\/bfnrt] | UNICODE) ;
fragment UNICODE : 'u' HEX HEX HEX HEX ;
fragment HEX : [0-9a-fA-F] ;

BGNL
    :   'BGNLaergayergfuybgv'
    ;

MeaningfulSplit : '=== meaningful ^ ===' ;

fragment Equote_double : '"' ;

BSTART
    :   '开始'
    ;

BEND:   '结束'
    ;

Newline
    :   ('\r' '\n'?| '\n')// -> skip
    ;

WhiteSpace
    :   [ \t]+ -> skip
    ;

BlockComment
    :   '/*' .*? '*/' -> skip
    ;

LineComment
    :   '//' ~[\r\n]* -> skip
    ;`;
</script>


<!-- 
<script src="lib/require.js"></script>
<script>
Converter = require('./Converter').Converter;
</script>
 -->

<script src="Converter.bundle.min.js"></script>


<script>
function runOne(){
    var grammerFile = input_B.value;
    
    converter = new Converter().init();
    converter.generBlocks(grammerFile,[]);
    printf(converter.blocks);

    converter.renderGrammerName();

    converter.generToolbox();
    printf(converter.toolbox);

    converter.generMainFile();

    console.log(converter);

}
runOne();
</script>
</body>
</html>