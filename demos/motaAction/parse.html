<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<title>MotaAction --antlr-blockly</title>
</head><body>

<p>
<button onclick="showXML()">Show XML</button>
<button onclick="runCode()">console.log(obj=code)</button>
<select id="entryType">
    <option value="event">event</option>
    <option value="point">point</option>
    <option value="shop">shop</option>
    <option value="afterBattle">afterBattle</option>
    <option value="afterGetItem">afterGetItem</option>
    <option value="afterOpenDoor">afterOpenDoor</option>
</select>
<button onclick="parse()">parse</button>
</p>
<div id="blocklyDiv" style="height: 480px; width: 940px;"></div>
<textarea id="codeArea" style="width: 100%; height: 17.2em;overflow:y;/* resize:none; */" spellcheck="false"></textarea>

<xml id="toolbox" style="display:none">
    <category name="entry"></category>
    <category name="statement"></category>
    <category name="value"></category>
    <category name="template"></category>
</xml>


<xml id='initscript' style="display:none">

var getCategory = function(name){
  for(var node of document.getElementById('toolbox').children) {
    if(node.getAttribute('name')==name) return node;
  }
}

toolboxObj = {
    'entry':[
        MotaActionFunctions.actionParser.parse([
            "欢迎使用事件编辑器",
            "本事件触发一次后会消失",
            {"type": "hide", "time": 500},
        ],'event'),
        MotaActionFunctions.actionParser.parse({"type": "choices", "choices": [
            {"text": "攻击+${point}", "action": [
                {"type": "setValue", "name": "status:atk", "value": "status:atk+${point}"},
            ]},
            {"text": "防御+${2*point}", "action": [
                {"type": "setValue", "name": "status:def", "value": "status:def+${2*point}"},
            ]},
            {"text": "生命+${200*point}", "action": [
                {"type": "setValue", "name": "status:hp", "value": "status:hp+${200*point}"},
            ]},
        ]},'point'),
        MotaActionFunctions.actionParser.parse({
            "id": "moneyShop1",
            "name": "贪婪之神", 
            "icon": "blueShop",
            "textInList": "1F金币商店", 
            "use": "money",
            "need": "20+10*times*(times+1)",  
            "text": "勇敢的武士啊，给我${need}金币就可以：", 
            "choices": [ 
                {"text": "生命+800", "effect": "status:hp+=800"},
                {"text": "攻击+4", "effect": "status:atk+=4"},
                {"text": "防御+4", "effect": "status:def+=4"},
                {"text": "魔防+10", "effect": "status:mdef+=10"}
            ]
        },'shop'),
        MotaActionBlocks['afterBattle_m'].xmlText(),
        MotaActionBlocks['afterGetItem_m'].xmlText(),
        MotaActionBlocks['afterOpenDoor_m'].xmlText(),
    ],
    'statement':[
        '&lt;label text="显示文字">&lt;/label>',
        MotaActionBlocks['text_0_s'].xmlText(),
        MotaActionBlocks['text_1_s'].xmlText(),
        MotaActionBlocks['tip_s'].xmlText(),
        MotaActionBlocks['openShop_s'].xmlText(),
        MotaActionBlocks['win_s'].xmlText(),
        MotaActionBlocks['lose_s'].xmlText(),
        MotaActionBlocks['choices_s'].xmlText([
            '选择剑或者盾','流浪者','man',MotaActionBlocks['choicesContext'].xmlText([
                '剑',MotaActionFunctions.actionParser.parseList([{"type": "openDoor", "loc": [3,3]}]),
                MotaActionBlocks['choicesContext'].xmlText([
                    '盾',MotaActionFunctions.actionParser.parseList([{"type": "openDoor", "loc": [9,3]}]),
                ])
            ])
        ]),
        '&lt;label text="勇士相关">&lt;/label>',
        MotaActionBlocks['setValue_s'].xmlText(),
        MotaActionBlocks['update_s'].xmlText(),
        MotaActionBlocks['moveHero_s'].xmlText(),
        MotaActionBlocks['changeFloor_s'].xmlText(),
        MotaActionBlocks['changePos_0_s'].xmlText(),
        MotaActionBlocks['changePos_1_s'].xmlText(),
        MotaActionBlocks['battle_s'].xmlText(),
        MotaActionBlocks['openDoor_s'].xmlText(),
        '&lt;label text="事件控制">&lt;/label>',
        MotaActionBlocks['if_s'].xmlText(),
        MotaActionBlocks['revisit_s'].xmlText(),
        MotaActionBlocks['exit_s'].xmlText(),
        MotaActionBlocks['show_s'].xmlText(),
        MotaActionBlocks['hide_s'].xmlText(),
        MotaActionBlocks['trigger_s'].xmlText(),
        MotaActionBlocks['move_s'].xmlText(),
        MotaActionBlocks['disableShop_s'].xmlText(),
        '&lt;label text="画面声音">&lt;/label>',
        MotaActionBlocks['sleep_s'].xmlText(),
        MotaActionBlocks['setFg_0_s'].xmlText(),
        MotaActionBlocks['setFg_1_s'].xmlText(),
        MotaActionBlocks['playBgm_s'].xmlText(),
        MotaActionBlocks['pauseBgm_s'].xmlText(),
        MotaActionBlocks['resumeBgm_s'].xmlText(),
        MotaActionBlocks['playSound_s'].xmlText(),
        '&lt;label text="其他">&lt;/label>',
        MotaActionBlocks['function_s'].xmlText(),
    ],
    'value':[
        MotaActionBlocks['setValue_s'].xmlText(),
        MotaActionBlocks['expression_arithmetic_0'].xmlText(),
        MotaActionBlocks['negate_e'].xmlText(),
        MotaActionBlocks['bool_e'].xmlText(),
        MotaActionBlocks['idString_e'].xmlText(),
        MotaActionBlocks['idString_1_e'].xmlText(),
        MotaActionBlocks['idString_2_e'].xmlText(),
        MotaActionBlocks['evalString_e'].xmlText(),
    ],
    'template':[
        '&lt;label text="获取用户输入的字符串">&lt;/label>',
        MotaActionFunctions.actionParser.parseList([
            {"type": "setValue", "name": "flag:inputMsg", "value": "请输入密码"},
            {"type": "function", "function": "function(){\ncore.setFlag('input',prompt(core.getFlag('inputMsg','请输入字符串'),'xxx'))\n}"},
            {"type": "if", "condition": "flag:input == 123456","true": [],"false": []},
        ]),
        '&lt;label text="战前剧情">&lt;/label>',
        MotaActionFunctions.actionParser.parse({ 
            "trigger": "action", 
            "displayDamage": true, 
            "data": [ 
                ' ... 战前剧情',
                {"type": "battle", "id": "xxx"},
                ' ... 战后剧情；请注意上面的强制战斗不会使怪物消失，需要调动{"type": "hide"}',
                {"type": "hide"},
            ]
        },'event'),
    ],
}
var toolboxgap = '&lt;sep gap="5">&lt;/sep>'
//xml_text = MotaActionFunctions.actionParser.parse(obj,type||'event')
//MotaActionBlocks['idString_e'].xmlText()

for (var name in toolboxObj){
    getCategory(name).innerHTML = toolboxObj[name].join(toolboxgap);
}

var workspace = Blockly.inject('blocklyDiv',{
  media: '../../media/',
  toolbox: document.getElementById('toolbox'),
  zoom:{
    controls: true,
    wheel: true,//false
    startScale: 1.0,
    maxScale: 3,
    minScale: 0.3,
    scaleSpeed: 1.08
  },
  trashcan: false,
});

function omitedcheckUpdateFunction(event) {
  console.log(event);
  try {
    var code = Blockly.JavaScript.workspaceToCode(workspace);
    document.getElementById('codeArea').value = code;
  } catch (error) {
    document.getElementById('codeArea').value = String(error);
    if (error instanceof OmitedError){
      var blockName = error.blockName;
      var varName = error.varName;
      var block = error.block;
    }
    console.log(error);
  }
}

workspace.addChangeListener(omitedcheckUpdateFunction);

workspace.addChangeListener(Blockly.Events.disableOrphans);

</xml>


<!-- <script src="../../src/lib/require.js"></script>
<script>
Converter = require('../../src/Converter').Converter;
</script> -->
<script src="../../Converter.bundle.min.js"></script>

<script src="../../blockly_compressed.js"></script>
<script src="../../blocks_compressed.js"></script>
<script src="../../javascript_compressed.js"></script>
<script src="../../zh-hans.js"></script>
<script>
input_='';
function runOne(){
    printf = console.log;
    var grammerFile = input_;
    converter = new Converter().init();
    converter.generBlocks(grammerFile,[]);
    printf(converter.blocks);
    converter.renderGrammerName();
    converter.generToolbox();
    converter.generMainFile();
    printf(converter.mainFile.join(''));
    console.log(converter);



    var script = document.createElement('script');
    script.innerHTML = converter.mainFile[5]+document.getElementById('initscript').innerText;
    document.body.appendChild(script);
}
var xhr=new XMLHttpRequest();
xhr.onreadystatechange = function (){
    if(xhr.readyState!=4) return;
    if(xhr.status!=200) {
        alert("无法在file://下加载");
        return;
    }
    input_=xhr.responseText;
    runOne();
}
xhr.open('GET','../../demos/motaAction/MotaAction.g4',true);
xhr.send(null);

function showXML() {
  xml = Blockly.Xml.workspaceToDom(workspace);
  xml_text = Blockly.Xml.domToPrettyText(xml);
  console.log(xml_text);
  xml_text = Blockly.Xml.domToText(xml);
  console.log(xml_text);
  console.log(xml);
}

function runCode() {
  // Generate JavaScript code and run it.
  window.LoopTrap = 1000;
  Blockly.JavaScript.INFINITE_LOOP_TRAP =
    'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
  code = Blockly.JavaScript.workspaceToCode(workspace);
  Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
  try {
    eval('obj=' + code.split('\n').join(''));
    console.log(obj);
  } catch (e) {
    alert(e);
  }
}

function parse() {
    MotaActionFunctions.parse(
        eval('obj=' + document.getElementById('codeArea').value.split('\n').join('')),
        document.getElementById('entryType').value
    );
}
</script>
</body>
</html>